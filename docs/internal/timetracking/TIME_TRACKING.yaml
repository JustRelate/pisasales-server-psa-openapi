openapi: 3.0.4

info:
  version: '8.4'
  title: Time tracking API
  description: All endpoints require an IAM authorization.  

paths:
  /salesportal/timerecord:
    get:
      summary: Fetch all recorded times
      description: Searches all recorded times.
      tags:
        - timerecord
      parameters:
        - $ref: '#/components/parameters/ids_query'
        - $ref: '#/components/parameters/_continuation_query'
        - $ref: '#/components/parameters/_order_query'
        - $ref: '#/components/parameters/_limit_query'
        - $ref: '#/components/parameters/_count_query'
      responses:
        '200':
          $ref: '#/components/responses/timerecords'
        '401':
          $ref: '#/components/responses/error_unauthorized'
        '403':
          $ref: '#/components/responses/error_no_access'
    post:
      summary: Record a new time
      description: This will create a new time record
      tags:
        - timerecord
      requestBody:
        description: The time record data
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/timerecord_writable'
      responses:
        '201':
          $ref: '#/components/responses/timerecord'
        '401':
          $ref: '#/components/responses/error_unauthorized'
        '403':
          $ref: '#/components/responses/error_no_access'
        '422':
          $ref: '#/components/responses/error_validation'

  /salesportal/timerecord/{id}:
    get:
      summary: Fetch a single recorded time
      description: Searches the _id of a recorded time
      tags:
        - timerecord
      parameters:
        - $ref: '#/components/parameters/id_path'
      responses:
        '200':
          $ref: '#/components/responses/timerecord'
        '401':
          $ref: '#/components/responses/error_unauthorized'
        '403':
          $ref: '#/components/responses/error_no_access'
        '404':
          $ref: '#/components/responses/error_record_not_found'
    patch:
      summary: Update a recorded time
      description: This will update an existing recorded time
      tags:
        - timerecord
      parameters:
        - $ref: '#/components/parameters/id_path'
      requestBody:
        description: The time record data
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/timerecord_writable'
      responses:
        '200':
          $ref: '#/components/responses/timerecord'
        '401':
          $ref: '#/components/responses/error_unauthorized'
        '403':
          $ref: '#/components/responses/error_no_access'
        '404':
          $ref: '#/components/responses/error_record_not_found'
        '422':
          $ref: '#/components/responses/error_validation'
    delete:
      summary: Delete a recorded time
      description: Searches the _id of a time record and deletes the record
      tags:
        - timerecord
      parameters:
        - $ref: '#/components/parameters/id_path'
      responses:
        '204':
          description: The time record was deleted
        '401':
          $ref: '#/components/responses/error_unauthorized'
        '403':
          $ref: '#/components/responses/error_no_access'
        '404':
          $ref: '#/components/responses/error_record_not_found'

  /salesportal/timerecord-client:
    get:
      summary: Fetch all clients
      description: Searches all clients the user can access.
      tags:
        - timerecord-client
      parameters:
        - $ref: '#/components/parameters/ids_query'
        - $ref: '#/components/parameters/_continuation_query'
        - $ref: '#/components/parameters/_order_query'
        - $ref: '#/components/parameters/_limit_query'
        - $ref: '#/components/parameters/_count_query'
        - $ref: '#/components/parameters/_search_query'
        - $ref: '#/components/parameters/user_query'
      responses:
        '200':
          $ref: '#/components/responses/clients'
        '401':
          $ref: '#/components/responses/error_unauthorized'
        '403':
          $ref: '#/components/responses/error_no_access'

  /salesportal/timerecord-client/{id}:
    get:
      summary: Fetch a single client
      description: Searches the _id of a client. The user needs access to this client in order to find it.
      tags:
        - timerecord-client
      parameters:
        - $ref: '#/components/parameters/id_path'
        - $ref: '#/components/parameters/user_query'
      responses:
        '200':
          $ref: '#/components/responses/client'
        '401':
          $ref: '#/components/responses/error_unauthorized'
        '403':
          $ref: '#/components/responses/error_no_access'
        '404':
          $ref: '#/components/responses/error_record_not_found'

  /salesportal/timerecord-description:
    get:
      summary: Fetch standard descriptions for an order
      description: Descriptions of standard tasks.
      tags:
        - timerecord-description
      parameters:
        - $ref: '#/components/parameters/_order_query'
        - $ref: '#/components/parameters/order_query'
      responses:
        '200':
          $ref: '#/components/responses/descriptions'
        '401':
          $ref: '#/components/responses/error_unauthorized'
        '403':
          $ref: '#/components/responses/error_no_access'

  /salesportal/timerecord-order:
    get:
      summary: Fetch all orders
      description: Searches all orders for a client. If no client is specied only internal orders are fetched.
      tags:
        - timerecord-order
      parameters:
        - $ref: '#/components/parameters/ids_query'
        - $ref: '#/components/parameters/_continuation_query'
        - $ref: '#/components/parameters/_order_query'
        - $ref: '#/components/parameters/_limit_query'
        - $ref: '#/components/parameters/_count_query'
        - $ref: '#/components/parameters/_search_query'
        - $ref: '#/components/parameters/client_query'
      responses:
        '200':
          $ref: '#/components/responses/orders'
        '401':
          $ref: '#/components/responses/error_unauthorized'
        '403':
          $ref: '#/components/responses/error_no_access'

  /salesportal/timerecord-order/{id}:
    get:
      summary: Fetch a single order
      description: Searches the _id of an order. The orders are limited to the client specified by the query parameter.
      tags:
        - timerecord-order
      parameters:
        - $ref: '#/components/parameters/id_path'
        - $ref: '#/components/parameters/client_query'
      responses:
        '200':
          $ref: '#/components/responses/order'
        '401':
          $ref: '#/components/responses/error_unauthorized'
        '403':
          $ref: '#/components/responses/error_no_access'
        '404':
          $ref: '#/components/responses/error_record_not_found'

  /salesportal/timerecord-position:
    get:
      summary: Fetch all order positions
      description: Searches all position.
      tags:
        - timerecord-position
      parameters:
        - $ref: '#/components/parameters/_order_query'
        - $ref: '#/components/parameters/_limit_query'
        - $ref: '#/components/parameters/_count_query'
        - $ref: '#/components/parameters/_search_query'
        - $ref: '#/components/parameters/_order_query'
        - $ref: '#/components/parameters/order_query'
      responses:
        '200':
          $ref: '#/components/responses/positions'
        '401':
          $ref: '#/components/responses/error_unauthorized'
        '403':
          $ref: '#/components/responses/error_no_access'

  /salesportal/timerecord-user:
    get:
      summary: Fetch all active users
      description: Searches all users.
      tags:
        - timerecord-user
      parameters:
        - $ref: '#/components/parameters/ids_query'
        - $ref: '#/components/parameters/_continuation_query'
        - $ref: '#/components/parameters/_order_query'
        - $ref: '#/components/parameters/_limit_query'
        - $ref: '#/components/parameters/_count_query'
        - $ref: '#/components/parameters/_search_query'
      responses:
        '200':
          $ref: '#/components/responses/users'
        '401':
          $ref: '#/components/responses/error_unauthorized'
        '403':
          $ref: '#/components/responses/error_no_access'

  /salesportal/timerecord-user/{id}:
    get:
      summary: Fetch a single user
      description: Searches the _id of a user.
      tags:
        - timerecord-user
      parameters:
        - $ref: '#/components/parameters/id_path'
      responses:
        '200':
          $ref: '#/components/responses/user'
        '401':
          $ref: '#/components/responses/error_unauthorized'
        '403':
          $ref: '#/components/responses/error_no_access'
        '404':
          $ref: '#/components/responses/error_record_not_found'

components:
  ########################################################################
  # parameters
  ########################################################################
  parameters:
    id_path:
      name: id
      in: path
      description: ID of the record
      required: true
      schema:
        type: string

    _continuation_query:
      name: _continuation
      in: query
      description: Continuation key that was returned with the last result list
      schema:
        type: string

    _search_query:
      name: _search
      in: query
      description: Full text (EUREKA) search term
      schema:
        type: string
        
    _order_query:
      name: _order
      in: query
      description: List of fields that should be used for ordering
      example: createdAt.desc,name.asc
      schema:
        type: string
        
    _limit_query:
      name: _limit
      in: query
      description: Maximum number of records to return. If the maximum is reached a continuation key will be in the response. The default value is 100.
      example: 10
      schema:
        type: number

    _count_query:
      name: _count
      in: query
      description: Count the total number of results available
      example: 'false'
      schema:
        type: boolean

    ids_query:
      name: ids
      in: query
      description: Search for multiple IDs. Values are separated by a comma
      example: 8065A97B2E1843E292CAAC1480EBAD84,F143C455A23E4A1B991D0DF2726755A6
      schema:
        type: string

    user_query:
      name: user
      in: query
      description: ID of the user to use for this request. Overrides the sessions user.
      example: 5FBA96F3D4F24AEDA664F8090C0A80E7
      schema:
        type: string

    client_query:
      name: user
      in: query
      description: ID of a client to search in this request.
      example: F9BB0AAA22C947BAE030A8C00C015B91
      schema:
        type: string

    order_query:
      name: order
      in: query
      required: true
      description: ID of an order to search in this request.
      example: 1150B8BAFC884A54935E3AF0F80DB9F1
      schema:
        type: string

  ########################################################################
  # responses
  ########################################################################
  responses:
    timerecord:
      description: time record data
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/timerecord'

    timerecords:
      description: a list of recorded times
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/timerecords'

    client:
      description: client data
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/client'

    clients:
      description: a list of clients
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/clients'

    description:
      description: description data
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/description'

    descriptions:
      description: a list of descriptions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/descriptions'

    order:
      description: order data
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/order'

    orders:
      description: a list of orders
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/orders'

    position:
      description: order position data
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/position'

    positions:
      description: a list of order positions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/positions'

    user:
      description: user data
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/user'

    users:
      description: a list of users
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/users'

    error_no_access:
      description: No access granted
      content:
        application/json:
          schema:
            oneOf:
              - $ref: '#/components/schemas/error_user_unknown'
              - $ref: '#/components/schemas/error_no_read_access'
              - $ref: '#/components/schemas/error_no_write_access'
              - $ref: '#/components/schemas/error_no_delete_access'

    error_validation:
      description: The submitted data had errors
      content:
        application/json:
          schema:
            oneOf:
              - $ref: '#/components/schemas/error_invalid_data'
              - $ref: '#/components/schemas/error_missing_data'
              - $ref: '#/components/schemas/error_unexpected_validation_failed'

    error_unauthorized:
      description: The authenticated failed
      content:
        application/json:
          schema:
            oneOf:
              - $ref: '#/components/schemas/error_unauthorized'
              - $ref: '#/components/schemas/error_credentials_invalid'
              - $ref: '#/components/schemas/error_credentials_ambiguous'

    error_record_not_found:
      description: The record was not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/error_record_not_found'

  schemas:
    ########################################################################
    # objects
    ########################################################################
    object:
      type: object
      properties:
        _id:
          type: string
          description: Identifier of the record
          example: F9BB0AAA22C947BAE030A8C00C015B91
  
    system_fields:
      type: object
      properties:
        updatedAt:
          type: string
          description: Date of the last update of this record
          example: 2024-10-15T09:47:44Z
        updatedBy:
            type: string
            description: contact id of the last person who has updated this record
            example: D1E9954702698E6BE030A8C029015B96
        createdAt:
          type: string
          description: Date when this record was created
          example: 2024-10-15T09:47:44Z
        createdBy:
          type: string
          description: contact id of the person who has created this record
          example: D1E9954702698E6BE030A8C029015B96

    timerecord:
      description: time record object
      type: object
      allOf:
        - $ref: '#/components/schemas/object'
        - $ref: '#/components/schemas/timerecord_writable'

    timerecords:
      type: object
      properties:
        continuation:
          type: string
          description: key that is used to fetch the next result page
        count:
          type: integer
          description: the total number of results
          example: 1
        results:
          type: array
          items:
            $ref: '#/components/schemas/timerecord'

    timerecord_writable:
      type: object
      properties:
        recordedAt:
          type: string
          description: The date at which the work was done
          example: 2025-11-06T14:13:55Z
        user:
          type: string
          description: ID of the user
          example: 95528891FB8145CBB53E9D8DF8D4D4BC
        client:
          type: string
          description: ID of the client (customer)
          example: 55C8499AEC8D4C63B8D388F07227755B
        order:
          type: string
          description: ID of the order
          example: 7F1DE5E5680348029FC29444E8446284
        position:
          type: string
          description: ID of the order position
          example: 8F9B9383CACD485D9A83704E8D47CC03
        budget:
          type: string
          description: ID of the budget used for this record
          example: 89B0BE9E03B34C5BB2261F66062B36B7
        duration:
          type: number
          description: Hours to be billed
          example: 2.0
        recordedDuration:
          type: number
          description: Hour worked
          example: 3.0
        location:
          type: string
          description: ''
          example: JustRelate
        description:
          type: string
          description: Description of the activity
          example: Bug tracking XYZ
        internalNote:
          type: string
          description: Internal note
          example: Took a long time to setup the test system
        billable:
          type: boolean
          description: Can this activity be billed?
          example: true
        billed:
          type: boolean
          description: Was this activity billed?
          example: true
        status:
          type: string
          description: Status of the recorded time
          enum: [CSO_TIM_STA_OPN, CSO_TIM_STA_FRE, CSO_TIM_STA_CHK]
          example: CSO_TIM_STA_OPN

    client:
      description: Client object
      type: object
      allOf:
        - $ref: '#/components/schemas/object'
      properties:
        name:
          type: string
          description: The company name
          example: ACME Ltd.

    clients:
      type: object
      properties:
        continuation:
          type: string
          description: key that is used to fetch the next result page
        count:
          type: integer
          description: the total number of results
          example: 1
        results:
          type: array
          items:
            $ref: '#/components/schemas/client'

    description:
      description: Description object
      type: object
      allOf:
        - $ref: '#/components/schemas/object'
      properties:
        name:
          type: string
          description: The company name
          example: Jour fixe
        order: 
          type: string
          description: ID of the order
          example: 1150B8BAFC884A54935E3AF0F80DB9F1

    descriptions:
      type: object
      properties:
        results:
          type: array
          items:
            $ref: '#/components/schemas/description'

    order:
      description: Order object
      type: object
      allOf:
        - $ref: '#/components/schemas/object'
      properties:
        name:
          type: string
          description: The order keyword
          example: Version upgrade
        client: 
          type: string
          description: ID of the client of the order
          example: DF270DD715A74D8FB268FB4295101F05

    orders:
      type: object
      properties:
        continuation:
          type: string
          description: key that is used to fetch the next result page
        count:
          type: integer
          description: the total number of results
          example: 1
        results:
          type: array
          items:
            $ref: '#/components/schemas/order'

    position:
      description: Order position object
      type: object
      allOf:
        - $ref: '#/components/schemas/object'
      properties:
        name:
          type: string
          description: The position name
          example: Kick off meeting
        order: 
          type: string
          description: ID of the order
          example: 1150B8BAFC884A54935E3AF0F80DB9F1
        position:
          type: string
          description: Name of the original position if this is a budget
          example: Project manager
        budget:
          type: string
          description: ID of the associated budget
          example: AC11E349A7C34DE4B0961DF4929EB72B
        open:
          type: number
          description: number of open hours available on this position
          example: 12.0

    positions:
      type: object
      properties:
        count:
          type: integer
          description: the total number of results
          example: 1
        results:
          type: array
          items:
            $ref: '#/components/schemas/position'

    user:
      description: User object
      type: object
      allOf:
        - $ref: '#/components/schemas/object'
      properties:
        name:
          type: string
          description: The user name (geiven name and family name)
          example: John Doe
        email:
          type: string
          description: The email address of the user
          example: john.doe@tynacoon.com

    users:
      type: object
      properties:
        continuation:
          type: string
          description: key that is used to fetch the next result page
        count:
          type: integer
          description: the total number of results
          example: 1
        results:
          type: array
          items:
            $ref: '#/components/schemas/user'

    ########################################################################
    # errors
    ########################################################################

    error_user_unknown:
      description: The authenticated IAM user was not found
      type: object
      properties:
        code:
          type: string
          example: 'user.unknown'
        error:
          type: string
          example: 'The user was not found'
        details:
          type: object
          properties:
            email:
              type: string
              example: 'john.doe@acme.org'

    error_no_read_access:
      description: The user has no read access to a record
      type: object
      properties:
        code:
          type: string
          example: 'record.access.no_read'
        error:
          type: string
          example: 'No read access on the record'
        details:
          type: object
          properties:
            id:
              type: string
              example: 'E899284D92502DB3E030A8C00C01133D'
            dto:
              type: string
              example: PSA_ORG
            title: 
              type: string
              example: ACME Ltd.

    error_no_write_access:
      description: The user has no write access to a record
      type: object
      properties:
        code:
          type: string
          example: 'record.access.no_write'
        error:
          type: string
          example: 'No write access on the record'
        details:
          type: object
          properties:
            id:
              type: string
              example: 'E899284D92502DB3E030A8C00C01133D'
            dto:
              type: string
              example: PSA_ORG
            title: 
              type: string
              example: ACME Ltd.

    error_no_delete_access:
      description: The user has no delete access to a record
      type: object
      properties:
        code:
          type: string
          example: 'record.access.no_delete'
        error:
          type: string
          example: 'No delete access on the record'
        details:
          type: object
          properties:
            id:
              type: string
              example: 'E899284D92502DB3E030A8C00C01133D'
            dto:
              type: string
              example: PSA_ORG
            title: 
              type: string
              example: ACME Ltd.
            
    error_unauthorized:
      description: The authenticated IAM user was not found
      type: object
      properties:
        code:
          type: string
          example: 'credentials.unknown_user'
        error:
          type: string
          example: 'The provided credentials belong to an unknown user'
        details:
          type: object
          properties:
            email:
              type: string
              example: 'john.doe@acme.com'

    error_credentials_invalid:
      description: The provided credentials are invalid
      type: object
      properties:
        code:
          type: string
          example: credentials.invalid
        error:
          type: string
          example: The provided credentials are invalid

    error_credentials_ambiguous:
      description: The provided credentials are ambiguous
      type: object
      properties:
        code:
          type: string
          example: credentials.ambiguous
        error:
          type: string
          example: The provided credentials are ambiguous

    error_record_not_found:
      description: The record was not found
      properties:
        code:
          type: string
          example: 'record.not_found'
        error:
          type: string
          example: 'The record was not found'
        details:
          type: object
          properties:
            id:
              type: string
              example: 'XXX'

    error_invalid_data:
      description: The provided data was not valid
      type: object
      properties:
        code:
          type: string
          example: 'validation.invalid_values'
        error:
          type: string
          example: 'A validation has failed'
        details:
          type: object
          properties:
            validation_errors:
              type: object
              properties:
                field:
                  type: string
                  example: agent
                reason:
                  type: string
                  example: invalid_value
                message:
                  type: string
                  example: "The field 'entity' contains the invalid value 'D07C1943E1929F83E030A8C0290112EB'"

    error_missing_data:
      description: Not all necessary data was submitted by the client
      type: object
      properties:
        code:
          type: string
          example: 'validation.invalid_values'
        error:
          type: string
          example: 'A validation has failed'
        details:
          type: object
          properties:
            validation_errors:
              type: object
              properties:
                field:
                  type: string
                  example: title
                reason:
                  type: string
                  example: missing
                message:
                  type: string
                  example: "The field 'title' is missing or empty"

    error_unexpected_validation_failed:
      description: The provided data failed a validation
      type: object
      properties:
        code:
          type: string
          example: 'validation.failed'
        error:
          type: string
          example: The provided data failed a validation
        details:
          type: object
          properties:
            cause:
              type: string
              example: data size too long for field!
